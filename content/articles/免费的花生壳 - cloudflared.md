---
updated_at: 2024-10-27T11:31:09.698+08:00
edited_seconds: 220
tags:
  - IT/æŠ˜è…¾/cloudflare
created_at: Sun, Dec 15th, 2024 - 16:03:07
banner_icon: ğŸ“‚
banner: https://cdn.jsongo.top/banners/f53c5884b5505531f32ad8fa0fc57247.jpg
description: é€šè¿‡ cloudflare æä¾›çš„å…è´¹è½¯ä»¶å’ŒæœåŠ¡ï¼Œæ­å»ºä¸€æ¡å…è´¹çš„ Tunnel ç©¿é€å†…ç½‘ï¼Œå¹¶æŒ‡å®šè‡ªå®šä¹‰åŸŸåæ¥è®¿é—®ä½ çš„å†…ç½‘æœåŠ¡ï¼Œå…³é”®è¿˜æ²¡æœ‰ç½‘é€Ÿé™åˆ¶
title: å…è´¹çš„èŠ±ç”Ÿå£³ - cloudflared
slug: build-a-cloudflared-tunnel
draft: false
---
ä¸€èˆ¬æˆ‘ä»¬ä¹ æƒ¯ç”¨èŠ±ç”Ÿå£³æ¥å®ç°å†…ç½‘ç©¿é€ï¼Œä¸è¿‡èŠ±ç”Ÿå£³æœ¬èº«æ˜¯è¦æ”¶é’±çš„ï¼Œå®ƒçš„åŸŸåä¹Ÿè¦æ”¶é’±ï¼Œæµé‡ä¹Ÿæ”¶ä¸€æ¬¡é’±ï¼Œè€Œä¸”ç»™äº†é’±ä¹‹åå®ƒçš„æµé‡å¸¦å®½ä¹Ÿå—åˆ°é™åˆ¶ï¼Œæ­£å¸¸æ˜¯ 1M å¸¦å®½ä¸‹è½½é€Ÿåº¦åªæœ‰ 100 å¤š kï¼Œç”¨èµ·æ¥å¾ˆéš¾å—ï¼ŒåŠ ç‚¹å¸¦å®½å°±è¦åŠ ä¸å°‘é’±ã€‚è€Œä¸”æ¯ä¸ªæœˆè¿˜æœ‰æ€»æµé‡é™åˆ¶ï¼Œç»å¸¸ç”¨äº†åŠä¸ªæœˆå°±ä¸è¡Œäº†ï¼Œéå¸¸ç—›è‹¦ã€‚  
å…¶å® cloudflare æœ¬èº«å°±æä¾›äº†ä¸€ä¸ªå…è´¹çš„ cloudflared çš„ tunnel å·¥å…·ï¼Œç›´æ¥ä¸‹è½½è¿è¡Œå°±è¡Œã€‚å¦‚æœç”¨ Docker çš„è¯å¯ä»¥ç”¨è¿™ä¸ªé•œåƒï¼š[hub.docker.com/r/cloudflare/cloudflared](https://hub.docker.com/r/cloudflare/cloudflared) é‡Œé¢ä¹Ÿæœ‰ä¸€äº›ç®€å•çš„æŒ‡å¼•ã€‚
# ç®€å•ä½¿ç”¨
ä¸€æ¡å‘½ä»¤å°±å¯ä»¥æå®šï¼š
```bash
cloudflared tunnel --no-autoupdate --hello-world
```
ä¸è¿‡è¿™ä¹ˆè·‘ï¼Œæ¯”è¾ƒä¾èµ–äºä¸éœ€è¦ Cloudflare å¸æˆ·çš„å…¬å…± trycloudflare.comï¼Œå¾ˆä¸ç¨³å®šï¼Œæˆ‘ä¹‹å‰è¯•ç”¨è¿‡ï¼Œç»å¸¸æ–­ï¼Œç½‘é€Ÿä¹Ÿä¸ç¨³å®šã€‚è¦å®é™…ä¸Šçº¿ä½¿ç”¨çš„è¯ï¼Œè¿˜æ˜¯å¾—è‡ªå·±æ³¨å†Œä¸€ä¸ª cloudflare è´¦å·ï¼Œä¸‹é¢ä»‹ç»ã€‚
# æ­å»ºä¸ªäºº Tunnel ç½‘ç»œ
## æ³¨å†Œä¸€ä¸ª Tunnel
åˆ° [Cloudflare One](https://dash.teams.cloudflare.com/â ) ä¸Šæ³¨å†Œä¸€ä¸ª Cloudflare Zero Trust åŸŸåï¼Œé€‰ Free å°±å¯ä»¥äº†  
	![|875](https://cdn.jsongo.top/2024/12/420352862a7523747b97d596ff767b81.webp)  
æ¥ä¸‹å»å®ƒä¼šè®©ä½ ç»‘å®šä¸€ä¸ªæ”¯ä»˜å¡ï¼Œå³ä½¿é€‰çš„æ˜¯å…è´¹çš„ã€‚è¿™æ˜¯æµ·å¤–å„ç±»æœåŠ¡çš„å¸¸è§æ“ä½œï¼Œå› ä¸ºæ”¶è´¹è®¡åˆ’å¯èƒ½ä¼šå˜ï¼Œè€Œä¸”ä½ ä½¿ç”¨æ—¶ä¹Ÿå¯èƒ½ä¼šè¶…é¢ï¼Œæ‰€ä»¥å…ˆè®©ä½ æŠŠæ‰£è´¹çš„æ–¹å¼ç•™å¥½ï¼Œä»¥å¤‡åé¢éœ€è¦çš„æ—¶å€™èƒ½æ‰£åˆ°é’±ã€‚  
æ³¨å†Œå®Œåï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥åˆ›å»ºä¸€ä¸ª tunnelï¼Œå…¶å®è¿‡ç¨‹ä¹Ÿå¾ˆç®€å•ã€‚
>  è¿™äº›æ˜¯ä¸€æ­¥æ­¥æ‘¸ç´¢å‡ºæ¥çš„ï¼Œæ²¡æœ‰å‚è€ƒå…¶å®ƒå¤–éƒ¨çš„æŒ‡å¼•ï¼Œæ‰€ä»¥å¯èƒ½ä¼šæœ‰æ›´å¥½çš„åŠæ³•ã€‚å¸Œæœ›æœ‰è¯»è€…æ‰¾åˆ°æ›´å¥½çš„æ–¹æ³•æ—¶ï¼Œèƒ½ç»™æˆ‘ç•™ä¸ªè¯„è®ºï¼Œæ„Ÿæ¿€ä¸å°½ã€‚
## åˆ›å»º Tunnel
åœ¨ä¸‹å›¾ä¸­çš„èœå•é‡Œæ‰¾åˆ°åˆ›å»ºçš„åœ°æ–¹ï¼Œé€‰ Cloudflaredã€‚  
	![|875](https://cdn.jsongo.top/2024/12/5b690dff91048eeaeb5663f168c837a2.webp)  
è‡ªå·±å–ä¸€ä¸ªåå­—ï¼ˆä¸è·Ÿåˆ«äººé‡å¤å°±è¡Œï¼‰  
	![|900](https://cdn.jsongo.top/2024/12/8652218a31d2d78c56aa4f0a43edcf8d.webp)  
ä¸‹ä¸€æ­¥ï¼Œå–å¾— tokenï¼š  
	![|925](https://cdn.jsongo.top/2024/12/29b1a001c14459ba21b349c12cb4288d.webp)  
å¦‚ä¸Šå›¾ï¼Œåˆ’çº¿å¤„å°±æ˜¯ä½ çš„ tokenï¼Œå…ˆè®°ä¸‹æ¥ï¼Œä¸‹é¢ç”¨ã€‚
## å¯åŠ¨ã€æ¥å…¥
åˆ›å»ºå®Œä¹‹åï¼Œåœ¨æœ¬åœ°è¿è¡Œ cloudflared çš„å‘½ä»¤ï¼š
```bash
cloudflare tunnel --no-autoupdate run --token xxx
```
å¦‚æœä½¿ç”¨ docker çš„è¯ï¼Œå¯ä»¥ç”¨è¿™ä¸ª compose yml
```yml
version: '3.8'

services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    command: tunnel --no-autoupdate run --token xxxx
    restart: unless-stopped
    network_mode: host
    dns:
        - 1.1.1.1
```
å…¶ä¸­ï¼Œxxx æ¢æˆä½ è‡ªå·±çš„ tokenã€‚  
å¦‚æœä½ å®¶é‡Œæœ‰ä¸ªæœåŠ¡å™¨æˆ– NASï¼Œå…¶å® docker æ˜¯æ¯”è¾ƒåˆé€‚çš„ï¼Œå®ƒå¯ä»¥ä¸€ç›´åœ¨çº¿è·‘ã€‚  
åˆ›å»ºå®Œä¹‹åï¼Œåœ¨åŒä¸€ä¸ªç•Œé¢é‡Œå¯ä»¥çœ‹åˆ°å·²ç»æœ‰ä¸€ä¸ªè®¾å¤‡è¿æ¥ä¸Šæ¥äº†ï¼š  
	![|725](https://cdn.jsongo.top/2024/12/3c23fd4e318bb3198e69dd369ed24c29.webp)  
å†ä¸‹ä¸€æ­¥ï¼Œpublic hostnames é‡Œæ·»åŠ ä¸€ä¸ªä½ è½¬åˆ° cloudflare æ¥è§£æçš„åŸŸåï¼ŒåŠ ä¸€ä¸ªå­åŸŸåã€‚åŒæ—¶ Service å¡«å†™ä½ å†…ç½‘çš„æŸä¸ªæœåŠ¡çš„åœ°å€ï¼Œå¦‚ä½ çš„ nginx ç½‘å…³ç­‰ã€‚  
	![|875](https://cdn.jsongo.top/2024/12/0e9d6a0c0afadbd8100b681aab58a962.webp)  
å†ä¸‹ä¸€æ­¥å°±å›åˆ°äº†åˆ—è¡¨é¡µï¼Œå¯ä»¥çœ‹åˆ°ä½ çš„ tunnel å·²ç»åœ¨è·‘äº†ï¼š  
	![|850](https://cdn.jsongo.top/2024/12/f39e1282f64410a6862142f136b7108b.webp)  
å›åˆ°ä½ çš„ cloudflare DNS é…ç½®é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°å®ƒå¸®ä½ æ·»åŠ äº†ä¸€ä¸ª CNAMEï¼Œè¯´æ˜å·²ç»æˆåŠŸäº†  
	![|875](https://cdn.jsongo.top/2024/12/292affb6bfeac40389684bb915b7bce0.webp)  
	[DNS records Â· Cloudflare Zero Trust docs](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/routing-to-tunnel/dns/) è¿™æ¡ CNAME çš„è§„åˆ™æ˜¯ï¼š`<Tunnel ID>.cfargotunnel.com` ï¼Œè¿™ä¸ª Tunnel ID å¯ä»¥åœ¨ä¸Šæ–¹çš„æˆªå›¾ä¸­æ‰¾åˆ°ã€‚æ‰€ä»¥æ‰‹åŠ¨é…ç½®ä¹Ÿè¡Œã€‚
	
ç°åœ¨ä½ å¯ä»¥ç”¨åˆšé…ç½®çš„åŸŸåæ¥è®¿é—®ä½ çš„å†…ç½‘æœåŠ¡äº†ã€‚ç½‘é€Ÿå¾ˆå¿«ã€‚  
	![|750](https://cdn.jsongo.top/2024/12/7063c449ce57a9dfa970e2e9c6916d9e.webp)
## ä¼˜åŒ–ç½‘ç»œè¿æ¥
å¦‚æœä½ çš„æœåŠ¡éœ€è¦è€—æ—¶æ¯”è¾ƒä¹…ï¼Œæ¯”å¦‚ git æœåŠ¡ï¼Œæœ‰æ—¶ä½ æ‹‰å†…å®¹çš„æ—¶å€™éƒ½è¦å¥½å‡ åˆ†é’Ÿï¼Œé‚£å°±éœ€è¦è®¾ç½®è¿æ¥å’Œè¶…æ—¶æ—¶é•¿äº†ã€‚  
åœ¨ä¸Šé¢æˆ‘ä»¬é…ç½® publish hostname æ—¶ï¼Œä¸‹æ–¹å…¶å®è¿˜æœ‰é«˜çº§é…ç½®ï¼Œå¦‚ä¸‹å›¾ä½ç½®ï¼š  
	![|725](https://cdn.jsongo.top/2024/12/321e5240cb520e8f255d0afad7893609.webp)  
	è°ƒæ•´ä¸‹ timeout çš„æ—¶é•¿ï¼ˆé»˜è®¤ 30sï¼‰ï¼Œè¶…è¿‡ 30 ç§’å°±è‡ªåŠ¨å…³é—­é“¾æ¥äº†ï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹å¯ä»¥é€‚å½“è°ƒå¤§ä¸€äº›ã€‚
